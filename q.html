

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Preparation Questions &mdash; CS 323, Fall 2022 1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="_static/custom.css" />
  
  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="CS 323, Fall 2022 1 documentation" href="index.html"/>
        <link rel="up" title="Schedule" href="cal.html"/>
        <link rel="next" title="Reference Materials" href="refs.html"/>
        <link rel="prev" title="Schedule" href="cal.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> CS 323, Fall 2022</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="info.html">General Information</a><ul>
<li class="toctree-l2"><a class="reference internal" href="info.html#prerequisite">Prerequisite</a></li>
<li class="toctree-l2"><a class="reference internal" href="info.html#meetings">Meetings</a></li>
<li class="toctree-l2"><a class="reference internal" href="info.html#grades">Grades</a></li>
<li class="toctree-l2"><a class="reference internal" href="info.html#labs">Labs</a></li>
<li class="toctree-l2"><a class="reference internal" href="info.html#prep-questions">Prep Questions</a></li>
<li class="toctree-l2"><a class="reference internal" href="info.html#equipment-problems">Equipment Problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="info.html#other-policies">Other Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="info.html#text">Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="info.html#staff-ta">Staff/TA</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="cal.html">Schedule</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Preparation Questions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="refs.html">Reference Materials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="refs.html#c-programming">C Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="refs.html#unix">UNIX</a></li>
<li class="toctree-l2"><a class="reference internal" href="refs.html#x86-emulation">x86 Emulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="refs.html#x86-assembly-language">x86 Assembly Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="refs.html#pc-hardware-programming">PC Hardware Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="refs.html#reference-quizzes">Reference Quizzes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lab.html">Lab</a><ul>
<li class="toctree-l2"><a class="reference internal" href="lab/tools.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="lab/lab1.html">Lab 1: Booting a PC</a></li>
<li class="toctree-l2"><a class="reference internal" href="lab/lab2.html">Lab 2: Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="lab/lab3.html">Lab 3: User Environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="lab/lab4.html">Lab 4: Preemptive Multitasking</a></li>
<li class="toctree-l2"><a class="reference internal" href="lab/lab5.html">Lab 5: File system, Spawn and Shell</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">CS 323, Fall 2022</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="cal.html">Schedule</a> &raquo;</li>
      
    <li>Preparation Questions</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/q.rst.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <section id="preparation-questions">
<h1>Preparation Questions<a class="headerlink" href="#preparation-questions" title="Permalink to this heading">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>
By 11:59 AM before lecture, submit your answer
to 1) each lecture's question
and 2) <strong>own questions</strong> via https://github.gatech.edu/cs3210-fall2017 using your own prep repo cs3210-prep-YOUR-USERNAME
as a file named
<span id='lecno'> "lec[n].txt" (e.g,, "lec2.txt" for the second lecture)</span>.
</p><span id="lec"></span>

<style>
#preparation-questions .section {
  display: none;
}
</style>

<script>

$(function() {
  $.urlParam = function(name) {
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results == null) {
        return null;
    }
    else{
        return results[1] || 0;
    }
  }
    
  var all = $("#preparation-questions");

  var q = $.urlParam("q");
  var c = $.urlParam("c");
  var n = $.urlParam("n");

  var slug = "N/A";
  if (c == "lec")
    slug = "Lecture " + n;
  else if (c == "tut")
    slug = "Tutorial " + n;

  var lecno = c + n + ".txt";
  var title = $("<h2>").text("Question for " + slug + " (" + lecno + ")");

  if (c)
    $("#lecno").text(lecno);

  if (q != null && c != null && n != null) {
    var ele = all.find("#" + q);
    ele.find("h2").css("display", "none");
    ele.css("display", "block");
    $("#lec").append(title);
  }
});

</script><section id="intro">
<h2>intro<a class="headerlink" href="#intro" title="Permalink to this heading">¶</a></h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/xs6cDaXbsUA" frameborder="0" allowfullscreen></iframe><p>(optional)
Watch Peter Denning’s talk, “Perspectives on OS Foundations”,
presented at the SOSP History Day Workshop (SOSP’15).</p>
</section>
<section id="tools">
<h2>tools<a class="headerlink" href="#tools" title="Permalink to this heading">¶</a></h2>
<iframe width="420" height="315" src="https://www.youtube.com/embed/4XpnKHJAok8" frameborder="0" allowfullscreen></iframe><p>Read the <a class="reference external" href="lab/tools.html">Tools</a> page, install the software, and
submit the below the output of below commands?</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ git --version
$ qemu-system-i386 --version
$ uname -a
$ lsb_release -a
</pre></div>
</div>
<p>If you have more time, watch Linus’s talk on git and give us any
questions if you have. We will address your questions during the
tutorial.</p>
</section>
<section id="boot">
<h2>boot<a class="headerlink" href="#boot" title="Permalink to this heading">¶</a></h2>
<p>Let’s first understand your hardware, starting from the CPU
information. What’s your CPU and could you interpret each
fields of <em>your</em> output?</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ cat /proc/cpuinfo
processor       : <span class="m">0</span>
vendor_id       : GenuineIntel
cpu family      : <span class="m">6</span>
model           : <span class="m">61</span>
model name      : Intel<span class="o">(</span>R<span class="o">)</span> Core<span class="o">(</span>TM<span class="o">)</span> i7-5600U CPU @ <span class="m">2</span>.60GHz
stepping        : <span class="m">4</span>
microcode       : 0x21
cpu MHz         : <span class="m">2832</span>.273
cache size      : <span class="m">4096</span> KB
physical id     : <span class="m">0</span>
siblings        : <span class="m">4</span>
core id         : <span class="m">0</span>
cpu cores       : <span class="m">2</span>
apicid          : <span class="m">0</span>
initial apicid  : <span class="m">0</span>
fpu             : yes
fpu_exception   : yes
cpuid level     : <span class="m">20</span>
wp              : yes
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr
  pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht
  tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon
  pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu
  pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg
  fma cx16 xtpr pdcm pcid sse4_1 sse4_2 x2apic movbe popcnt
  tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm
  3dnowprefetch ida arat epb pln pts dtherm intel_pt tpr_shadow
  vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2
  smep bmi2 erms invpcid rtm rdseed adx smap xsaveopt
bugs            :
bogomips        : <span class="m">5189</span>.72
clflush size    : <span class="m">64</span>
cache_alignment : <span class="m">64</span>
address sizes   : <span class="m">39</span> bits physical, <span class="m">48</span> bits virtual
...
</pre></div>
</div>
<p>Read Appendix A/B and answer three questions below (concisely as possible):</p>
<ol class="arabic simple">
<li><p>Due to sector granularity, the call to readseg in the text is
equivalent to
<code class="docutils literal notranslate"><span class="pre">readseg((uchar*)0x100000,</span> <span class="pre">0xb500,</span> <span class="pre">0x1000)</span></code>. In practice, this sloppy behavior turns
out not to be a problem. Why doesn’t the sloppy readsect cause problems?</p></li>
<li><p>Suppose you wanted <code class="docutils literal notranslate"><span class="pre">bootmain()</span></code> to load the kernel at 0x200000 instead of
0x100000, and you did so by modifying <code class="docutils literal notranslate"><span class="pre">bootmain()</span></code> to add 0x100000 to the va of each
ELF section. Something would go wrong. What?</p></li>
<li><p>It seems potentially dangerous for the boot loader to copy the ELF
header to memory at the arbitrary location 0x10000.
Why doesn’t it call malloc to obtain the memory it needs?</p></li>
</ol>
</section>
<section id="unix">
<h2>unix<a class="headerlink" href="#unix" title="Permalink to this heading">¶</a></h2>
<iframe width="420" height="315" src="https://www.youtube.com/embed/tc4ROCJYbm0" frameborder="0" allowfullscreen></iframe><p>What kind of UNIX’s features do you see on today’s operating systems?
and what’s not? Do you see any missing features that are prevalent
in modern, commodity operating systems?</p>
</section>
<section id="basic">
<h2>basic<a class="headerlink" href="#basic" title="Permalink to this heading">¶</a></h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/de2Hsvxaf8M" frameborder="0" allowfullscreen></iframe><p>Read Bitwise operators, Pointers and Pointers to structures and answer the questions below:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1">#1 what will be output if you will execute following c code?</span>

  int array<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span><span class="m">0</span>,1,2,3<span class="o">}</span><span class="p">;</span>
  int* <span class="nv">x</span> <span class="o">=</span> array + <span class="m">1</span><span class="p">;</span>
  int <span class="nv">a</span> <span class="o">=</span> ++*x<span class="p">;</span>
  int <span class="nv">b</span> <span class="o">=</span> a + *x<span class="p">;</span>
  printf<span class="o">(</span><span class="s2">&quot;%d\n&quot;</span>, b<span class="o">)</span><span class="p">;</span>
  <span class="k">return</span> <span class="m">0</span><span class="p">;</span>

<span class="m">1</span><span class="o">)</span> <span class="m">0</span>
<span class="m">2</span><span class="o">)</span> <span class="m">1</span>
<span class="m">3</span><span class="o">)</span> <span class="m">2</span>
<span class="m">4</span><span class="o">)</span> <span class="m">3</span>
<span class="m">5</span><span class="o">)</span> <span class="m">4</span>
&gt; ANSWER :

<span class="c1">#2 what will be output if you will execute following c code?</span>

  <span class="c1">#define WHATISTHIS(a,b,c) ((a &gt;&gt; (b + 1 - c)) &amp; ~(~0 &lt;&lt; c))</span>
  <span class="c1">#define PRNT(a) \</span>
          printf<span class="o">(</span><span class="s2">&quot;value = 0x%08x\n&quot;</span>,a<span class="o">)</span><span class="p">;</span>


  int main<span class="o">()</span>
  <span class="o">{</span>
          unsigned <span class="nv">x</span> <span class="o">=</span> <span class="m">3210</span><span class="p">;</span>
          int <span class="nv">p</span> <span class="o">=</span> <span class="m">10</span><span class="p">;</span>
          int <span class="nv">n</span> <span class="o">=</span> <span class="m">4</span><span class="p">;</span>
          PRNT<span class="o">(</span>WHATISTHIS<span class="o">(</span>x,p,n<span class="o">))</span><span class="p">;</span>

          <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
  <span class="o">}</span>

<span class="m">1</span><span class="o">)</span> <span class="nv">value</span> <span class="o">=</span> 0x00000009
<span class="m">2</span><span class="o">)</span> <span class="nv">value</span> <span class="o">=</span> 0x00030120
<span class="m">3</span><span class="o">)</span> <span class="nv">value</span> <span class="o">=</span> 0x00000010
<span class="m">4</span><span class="o">)</span> <span class="nv">value</span> <span class="o">=</span> 0x00000004
<span class="m">5</span><span class="o">)</span> Compilation error
&gt; ANSWER :

<span class="c1">#3 what will be output if you will execute following c code?</span>

  int array<span class="o">[</span><span class="m">4</span><span class="o">]</span> <span class="o">=</span> <span class="o">{</span><span class="m">1</span>,2,3,4<span class="o">}</span><span class="p">;</span>
  <span class="k">if</span><span class="o">(</span>array<span class="o">[</span><span class="m">0</span><span class="o">]</span> - array<span class="o">[</span><span class="m">1</span><span class="o">]</span> &lt; sizeof<span class="o">(</span>array<span class="o">))</span> printf<span class="o">(</span><span class="s2">&quot;%d&quot;</span>,array<span class="o">[</span>sizeof<span class="o">(</span>char<span class="o">)])</span><span class="p">;</span>
  <span class="k">else</span> printf<span class="o">(</span><span class="s2">&quot;%d&quot;</span>, array<span class="o">[</span>sizeof<span class="o">(</span>short<span class="o">)])</span><span class="p">;</span>

<span class="m">1</span><span class="o">)</span> <span class="m">1</span>
<span class="m">2</span><span class="o">)</span> <span class="m">2</span>
<span class="m">3</span><span class="o">)</span> <span class="m">3</span>
<span class="m">4</span><span class="o">)</span> <span class="m">4</span>
<span class="m">5</span><span class="o">)</span> Compilation error
&gt; ANSWER :

<span class="c1">#4 Save the source code below as test.c</span>

  int main<span class="o">()</span>
  <span class="o">{</span>
    const char* <span class="nv">str1</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
    static char* <span class="nv">str2</span> <span class="o">=</span> <span class="s2">&quot;cs3210&quot;</span><span class="p">;</span>
    printf<span class="o">(</span><span class="s2">&quot;%s %s&quot;</span>, str1, str2<span class="o">)</span><span class="p">;</span>
  <span class="o">}</span>

  <span class="c1"># Follows the commands below, submit your ouput</span>
  <span class="nv">$gcc</span> -o <span class="nb">test</span> test.c
  <span class="nv">$readelf</span> -S ./test
  <span class="nv">$objdump</span> -s -j .rodata ./test
  <span class="nv">$objdump</span> -s -j .text ./test
  <span class="nv">$objdump</span> -s -j .data ./test
</pre></div>
</div>
<p>If you have more time, Please watch the youtube video. If you have a
question, Please write down with you answer.
You just need to write your answer the right next to “&gt;ANSWER:”,
attach your output and save your file as tut2.txt and submit the file
in our submission site.</p>
</section>
<section id="memory">
<h2>memory<a class="headerlink" href="#memory" title="Permalink to this heading">¶</a></h2>
<p>Please, read the set of article before the tutorial:</p>
<p>Caches:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="http://arstechnica.com/gadgets/2002/07/caching/">Cache basics</a></p></li>
<li><p><a class="reference external" href="https://people.freebsd.org/~lstewart/articles/cpumemory.pdf">What every programmer should know about memory</a> (optoinal)</p></li>
</ol>
<p>Linux process filesystem:</p>
<ol class="arabic simple" start="3">
<li><p><a class="reference external" href="http://man7.org/linux/man-pages/man5/proc.5.html">Man-page of proc pseudo file system</a>
or <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">5</span> <span class="pre">proc</span></code></p></li>
</ol>
<p>Concisely answer the following based on the readings:</p>
<ol class="arabic simple">
<li><p>Can you extract the <a class="reference external" href="https://en.wikipedia.org/wiki/Working_set_size">working set size</a>
of a program in Linux from the userspace?</p></li>
<li><p>What is the L1, L2 and LLC size of your system?</p></li>
<li><p>Consider you are working on x86 system.
What will be the size of this structure and why?</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">f</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="isolation">
<h2>isolation<a class="headerlink" href="#isolation" title="Permalink to this heading">¶</a></h2>
<p>This is a program that dumps a memory region that you specify. We are
going to see <strong>two types of memory isolation</strong> by using this toy program.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;err.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctype.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[usage] %s [mem-addr]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">strtol</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%016lx: &quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="mh">0x10</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="mh">0x10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;| &quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="mh">0x10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">isprint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>To compile, try <code class="docutils literal notranslate"><span class="pre">gcc</span> <span class="pre">-std=c99</span> <span class="pre">-o</span> <span class="pre">memdump</span> <span class="pre">memdump.c</span></code> after saving the above
snippet as <code class="docutils literal notranslate"><span class="pre">memdump.c</span></code>. To run, <code class="docutils literal notranslate"><span class="pre">./memdump</span> <span class="pre">[ADDR]</span></code>, and “[ADDR]”
should be the address that you want to read (e.g., “0x0000” to read
the virtual address 0.</p>
<ol class="arabic simple">
<li><p>Explain the above program.</p></li>
<li><p>Try,</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ ./memdump 0x0
zsh: segmentation fault  ./memdump 0x0

$ dmesg <span class="p">|</span> tail -1
<span class="o">[</span><span class="m">50612</span><span class="o">]</span> memdump<span class="o">[</span><span class="m">136</span><span class="o">]</span>: segfault at <span class="m">0</span> ip 000000000804855e sp 00000000ffa032f0 error <span class="m">4</span> <span class="k">in</span> mem-dump<span class="o">[</span><span class="m">8048000</span>+1000<span class="o">]</span>
</pre></div>
</div>
<p>What happen? Could you explain/interpret the line?</p>
<ol class="arabic simple" start="3">
<li><p>Let’s try to access a memory region in kernel. Pick any reasonable
virtual address depending on your architecture (32-bit or 64-bit).</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ ./memdump 0xfffffffffffff00
zsh: segmentation fault  ./memdump 0xfffffffffffff00

$ dmesg <span class="p">|</span> tail -1
<span class="o">[</span><span class="m">50809</span><span class="o">]</span> traps: memdump<span class="o">[</span><span class="m">139</span><span class="o">]</span> general protection ip:4006dd sp:7fff412ae540 error:0 <span class="k">in</span> a.out<span class="o">[</span><span class="m">400000</span>+1000<span class="o">]</span>
</pre></div>
</div>
<p>What happen? Could you explain/interpret the line?</p>
<ol class="arabic simple" start="4">
<li><p>Also, could you find a memory region that you can safely access
through <code class="docutils literal notranslate"><span class="pre">memdump</span></code>?</p></li>
<li><p>(Exercises 2 in the xv6 book)
KERNBASE limits the amount of memory a single process can use, which might be
irritating on a machine with a full 4 GB of RAM. Would raising KERNBASE allow a
process to use more memory?</p></li>
</ol>
</section>
<section id="bootloader">
<h2>bootloader<a class="headerlink" href="#bootloader" title="Permalink to this heading">¶</a></h2>
<p>Please, read the set of pages before the tutorial:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://0xax.gitbooks.io/linux-insides/content/Booting/linux-bootstrap-1.html">Linux Inside: Kernel booting process</a></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/Master_Boot_Record">Master Boot Record</a></p></li>
<li><p><a class="reference external" href="http://www.gnu.org/software/grub/manual/grub.html">GNU GRUB Manual 2.00</a> (optoinal)</p></li>
</ol>
<p>Concisely answer the following questions based on reading above:</p>
<ol class="arabic simple">
<li><p>When attempting to boot from a hard drive, what does the BIOS try to find?
(hint: a boot sector) where is the boot sector stored in?</p></li>
<li><p>There are a number of bootloaders that can boot Linux, such as GRUB 2 and
syslinux. Is there anything else? Specify two more.</p></li>
<li><p>What is the difference vmlinuz and vmlinux? why do we need kernel compression
and decompression?</p></li>
<li><p>Follows the commands below, submit your output</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ lsblk
$ grub-install -V
</pre></div>
</div>
</section>
<section id="pagetable">
<h2>pagetable<a class="headerlink" href="#pagetable" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Explain how ‘test.c’ and ‘readvirt.c’ work.</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// gcc -o test test.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;/proc/%d/pagemap, buf=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">getchar</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// gcc -o readvirt readvirt.c</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;err.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctype.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;inttypes.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[usage] %s [/proc/self/pagemap] [vaddr]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="kt">off_t</span><span class="w"> </span><span class="n">vaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGE_SIZE</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to open pagemap&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Q?</span>
<span class="w">  </span><span class="c1">// Only use for 64-bit</span>
<span class="w">  </span><span class="c1">//uint64_t off = ((uint64_t)vaddr / PAGE_SIZE) * sizeof(uint64_t);</span>
<span class="w">  </span><span class="c1">// Only use for 32-bit</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">vaddr</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">off</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to lseek&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">pfn</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pfn</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pfn</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pfn</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to read pfn&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Q?</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%&quot;</span><span class="w"> </span><span class="n">PRIx64</span><span class="w"> </span><span class="s">&quot;, pfn=%&quot;</span><span class="w"> </span><span class="n">PRIu64</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">pfn</span><span class="p">,</span><span class="w"> </span><span class="n">pfn</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7FFFFFFFFFFFFF</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>By using ‘readvirt’, we are going to find out the physical page of the
‘buf’ in the ‘test’ program. In doing so, you need two important
things, 1) /proc/kcore (an core interface to the live kernel), and 2)
the base virtual address of direct mapping (KERNBASE in xv6). In
Linux (64-bit), 0xFFFF880000000000 is your KERNBASE.  In Linux (32-bit),
0xC0000000 is your KERNBASE.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ ./test
/proc/9986/pagemap, <span class="nv">buf</span><span class="o">=</span>0xbf9e2a0c

$ sudo ./readvirt /proc/9986/pagemap 0xbf9e2a0c
0x860000000002cc28, <span class="nv">pfn</span><span class="o">=</span><span class="m">183336</span>

$ sudo gdb -c /proc/kcore

<span class="o">(</span>gdb<span class="o">)</span> x/30d 0xc0000000 + <span class="m">183336</span>*4096 + 0xa0c
0xecc28a0c: <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span>
0xecc28a14: <span class="m">8</span> <span class="m">9</span> <span class="m">10</span>  <span class="m">11</span>  <span class="m">12</span>  <span class="m">13</span>  <span class="m">14</span>  <span class="m">15</span>
0xecc28a1c: <span class="m">16</span>  <span class="m">17</span>  <span class="m">18</span>  <span class="m">19</span>  <span class="m">20</span>  <span class="m">21</span>  <span class="m">22</span>  <span class="m">23</span>
0xecc28a24: <span class="m">24</span>  <span class="m">25</span>  <span class="m">26</span>  <span class="m">27</span>  <span class="m">28</span>  <span class="m">29</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Please locate the physical page of ‘buf’ of ‘test’ (similar to
above), and explain to us how you locate the buf.</p></li>
<li><p>Please locate the physical page for the ‘main’ function of ‘test’,
and disassemble the code region to validate the content of the
physical page.</p></li>
</ol>
</section>
<section id="weird">
<h2>weird<a class="headerlink" href="#weird" title="Permalink to this heading">¶</a></h2>
<p>Please go through the following links:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="http://www.slideshare.net/scovetta/fundamentals-of-exploitationrevisited">Exploitation and state machines</a></p></li>
<li><p><a class="reference external" href="http://langsec.org/papers/Bratus.pdf">Exploit Programming</a> (till page 4 before
“Exploitation and the Fundamental Questions in Computing” section)</p></li>
</ol>
<p>Concisely answer the following question based on the readings
and another question on page table traversal:</p>
<ol class="arabic simple">
<li><p>What do you really understand by “weird machines”? (2-3 sentence)</p></li>
<li><p>Describe at least two examples of “weird machines”. (2-3 sentences for each)</p></li>
<li><p>How can you traverse the table directory/entry in JOS? Write a code snippet
to perform the page directory and page table traversal.</p></li>
</ol>
</section>
<section id="vmapps">
<h2>vmapps<a class="headerlink" href="#vmapps" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>If xv6 had not used super pages, what would be the right
declaration for <cite>entrypgdir</cite>?</p></li>
<li><p>Say you were an instructor and wanted to evaluate the understanding
of your students on xv6 (Chap 0-2). Please come up with two good
questions for quiz1 and provide to us. We plan to include a
few questions made by students for quiz1.</p></li>
</ol>
</section>
<section id="lazyalloc">
<h2>lazyalloc<a class="headerlink" href="#lazyalloc" title="Permalink to this heading">¶</a></h2>
<p>Please, read the links below.</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/C_dynamic_memory_allocation">C dynamic memory allocation</a></p></li>
<li><p><a class="reference external" href="http://man7.org/linux/man-pages/man2/sbrk.2.html">Man-page of sbrk</a>
or <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">2</span> <span class="pre">sbrk</span></code></p></li>
<li><p><a class="reference external" href="http://www3.physnet.uni-hamburg.de/physnet/Tru64-Unix/HTML/AQTLLATE/DOCU_012.HTM">Virtual Memory management</a></p></li>
</ol>
<p>Concisely answer the following based on the readings:</p>
<ol class="arabic simple">
<li><p>What is lazy memory allocation?</p></li>
<li><p>What is difference between lazy allocation policy and eager reservation policy?</p></li>
<li><p>When page fault happens,  how does Kernel allocate physical memory?</p></li>
</ol>
</section>
<section id="pre-proposal">
<h2>pre-proposal<a class="headerlink" href="#pre-proposal" title="Permalink to this heading">¶</a></h2>
<p>Please take a look on the <a class="reference external" href="https://tc.gtisc.gatech.edu/cs3210/2016/fall/proj.html">final project page</a>.</p>
<p>Please submit one page summary of your idea along with your
background. No more than 4 to a team. Please have each team member submit the same file with the names of all the team members at the top. You might want to follow this structure:</p>
<ol class="arabic simple">
<li><p>Background</p></li>
<li><p>Final Project Idea</p></li>
</ol>
</section>
<section id="div">
<h2>div<a class="headerlink" href="#div" title="Permalink to this heading">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;types.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;user.h&quot;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"></span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;usage: div x y</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">z</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d / %d = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">exit</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Save the above code as <cite>div.c</cite> and modify <cite>Makefile</cite> to include the
<cite>div</cite> program to the xv6 fs image. Please do each step and explain
in detail.</p>
<ol class="arabic simple">
<li><p>open <cite>div.asm</cite> and find the <cite>idivl</cite> instruction (e.g., at 0x62)</p></li>
<li><p>set a breakpoint at <cite>idivl</cite> (e.g., b *0x62)</p></li>
<li><p>run <cite>div 1 0</cite> in xv6 shell</p></li>
<li><p><cite>info registers</cite>, what’s <cite>cs</cite> &amp; <cite>esp</cite>?</p></li>
<li><p>single step: <cite>si</cite></p></li>
<li><p>check registers again: in kernel now!</p></li>
<li><p><cite>x/6x $esp</cite>?</p></li>
<li><p>run to <cite>trap()</cite>: who set <cite>tf1-&gt;trapno</cite>?</p></li>
</ol>
</section>
<section id="locking">
<h2>locking<a class="headerlink" href="#locking" title="Permalink to this heading">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;err.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">register</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">register</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;incl %0&quot;</span><span class="w"></span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;+m&quot;</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"></span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;m&quot;</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"></span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ncpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">upto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="n">pthread_t</span><span class="w"> </span><span class="o">*</span><span class="n">tids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">ncpu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pthread_t</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncpu</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">upto</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to creat a thread&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncpu</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">tids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;cpu = %d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ncpu</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Save the above code to ‘count.c’ and compile like below:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcc -std<span class="o">=</span>gnu99 -pthread -o count count.c
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Explain the code, and run the program like below:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ ./count <span class="m">1</span> <span class="m">1000</span>
<span class="nv">cpu</span> <span class="o">=</span> <span class="m">1</span>, <span class="nv">count</span> <span class="o">=</span> <span class="m">1000</span>

$ ./count <span class="m">2</span> <span class="m">1000</span>
<span class="nv">cpu</span> <span class="o">=</span> <span class="m">2</span>, <span class="nv">count</span> <span class="o">=</span> <span class="m">2000</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Interestingly, the total number of count is often not quite
correct. Please explain why that is happening?</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ ./count <span class="m">2</span> <span class="m">1000</span>
<span class="nv">cpu</span> <span class="o">=</span> <span class="m">2</span>, <span class="nv">count</span> <span class="o">=</span> <span class="m">1029</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>How to fix this problem?</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ ./count <span class="m">4</span> <span class="m">100000</span>
<span class="nv">cpu</span> <span class="o">=</span> <span class="m">4</span>, <span class="nv">count</span> <span class="o">=</span> <span class="m">400000</span>
</pre></div>
</div>
</section>
<section id="threads">
<h2>threads<a class="headerlink" href="#threads" title="Permalink to this heading">¶</a></h2>
<p>Please, read the first part of chapter 5 to understand what happens when a
kernel switches task from one process to other. Also look into the
following fork() method in proc.c file in xv6.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">fork</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">np</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Allocate process.</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocproc</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copyuvm</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">sz</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNUSED</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">sz</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Clear %eax so that fork returns 0 in the child.</span>
<span class="w">  </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">eax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NOFILE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">ofile</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">ofile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filedup</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">ofile</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idup</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">safestrcpy</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptable</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">np</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RUNNABLE</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptable</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Concisely answer the following based on the readings, and code:</p>
<ol class="arabic simple">
<li><p>What happens when kernel switches stack from one process to other?</p></li>
<li><p>Why is copyuvm() called? Also, will this be required when parent and child
process share address space?</p></li>
<li><p>How is the acquire and release method implemented in xv6?</p></li>
</ol>
</section>
<section id="sched">
<h2>sched<a class="headerlink" href="#sched" title="Permalink to this heading">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;err.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>

<span class="kt">double</span><span class="w"> </span><span class="nf">now</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="n">tv</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000000.0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cnt</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">beg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">register</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;incl %0&quot;</span><span class="w"></span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;+m&quot;</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"></span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;m&quot;</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"></span>
<span class="w">                 </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d: %.2f sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">beg</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[usage] %s [#proc] [count] [cmd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getuid</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;need to run as a root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ncpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">upto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// invoke n processes</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ncpu</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncpu</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">child</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d: runs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="n">run</span><span class="p">(</span><span class="n">upto</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// run a command over child pids</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">cmd</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%s %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">child</span><span class="p">[</span><span class="n">i</span><span class="mi">-3</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;execute: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ncpu</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Build the benchmark program by running <cite>gcc -o count count.c</cite>. Explain
how this benchmark works.</p></li>
<li><p>In Linux, users can change the scheduling policy of processes through
a <a class="reference external" href="http://linux-tips.org/t/how-to-use-chrt-command/268">chrt</a> (or <cite>man chrt</cite>)
command. Explain their four scheduling policies.</p></li>
<li><p>Run the command below and explain its result. (-f:  SCHED_FIFO)</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ sudo ./count <span class="m">10</span> <span class="m">10000000000</span> <span class="s2">&quot;chrt -f -p 99&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>How to sort all processes according to their pid
(i.e., as their execution time)? What are the proper commands
at “???”</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ sudo ./count <span class="m">5</span> <span class="m">1000000000</span> <span class="s2">&quot;???&quot;</span> ...
<span class="m">30433</span>: runs
<span class="m">30434</span>: runs
<span class="m">30435</span>: runs
execute: ...
<span class="m">30436</span>: runs
<span class="m">30437</span>: runs
execute: ...
execute: ...
execute: ...
execute: ...
<span class="m">30433</span>: <span class="m">2</span>.55 sec
<span class="m">30434</span>: <span class="m">2</span>.56 sec
<span class="m">30435</span>: <span class="m">2</span>.57 sec
<span class="m">30436</span>: <span class="m">2</span>.59 sec
<span class="m">30437</span>: <span class="m">4</span>.44 sec
</pre></div>
</div>
</section>
<section id="coordination">
<h2>coordination<a class="headerlink" href="#coordination" title="Permalink to this heading">¶</a></h2>
<p>Read “5. Scheduling” and answer the following question.</p>
<p>Sleep has to check <cite>lk != &amp;ptable.lock</cite> to avoid a deadlock.
It could eliminate the special case by replacing (2817-2820)</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">lk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptable</span><span class="p">.</span><span class="n">lock</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptable</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>with</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">release</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span><span class="w"></span>
<span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptable</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Doing this would break <cite>sleep()</cite>. How?</p>
</section>
<section id="concurrent-kv">
<h2>concurrent-kv<a class="headerlink" href="#concurrent-kv" title="Permalink to this heading">¶</a></h2>
<blockquote>
<div><ol class="upperroman simple" start="30">
<li><p>make it better ..</p></li>
</ol>
</div></blockquote>
<p>Read the provided <a class="reference external" href="r/kv.c">kv.c</a>  code. This is the
baseline code that you will modify in your tutorial
to make it scalable while ensuring locking. You do not
need to submit any answers for this tutorial prep.</p>
</section>
<section id="fsck">
<h2>fsck<a class="headerlink" href="#fsck" title="Permalink to this heading">¶</a></h2>
<p>We are going to add a new file entry to the <cite>fs.img</cite> by handcrafting
the image file (i.e., by using a hex editor such as hexedit, GHex, or
wxhexeditor). <cite>dumpfs.c</cite> is a tool that helps you parse <cite>fs.img</cite>.
Please download <a class="reference external" href="r/dumpfs.c">dumpfs.c</a>  and compile as below.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> xv6
$ make qemu

$ gcc -Werror -Wall -std<span class="o">=</span>gnu11 -o dumpfs dumpfs.c
$ ./dumpfs
&gt; sizeof<span class="o">(</span>superblock<span class="o">)</span> <span class="o">=</span> <span class="m">8</span>
<span class="nv">size</span> <span class="o">=</span> 000003e8 <span class="o">(</span>Size of file system image <span class="o">(</span>blocks<span class="o">))</span>
<span class="nv">nblocks</span> <span class="o">=</span> 000003ad <span class="o">(</span>Number of data blocks<span class="o">)</span>
<span class="nv">ninodes</span> <span class="o">=</span> 000000c8 <span class="o">(</span>Number of inodes<span class="o">)</span>
<span class="nv">nlog</span> <span class="o">=</span> 0000001e <span class="o">(</span>Number of log blocks<span class="o">)</span>
<span class="nv">logstart</span> <span class="o">=</span> <span class="m">00000002</span> <span class="o">(</span>Block number of first log block<span class="o">)</span>
<span class="nv">inodestart</span> <span class="o">=</span> <span class="m">00000020</span> <span class="o">(</span>Block number of first inode block<span class="o">)</span>
<span class="nv">bmapstart</span> <span class="o">=</span> 0000003a <span class="o">(</span>Block number of first free map block<span class="o">)</span>
&gt; <span class="nv">inode</span> <span class="o">=</span> <span class="m">1</span> <span class="o">(</span><span class="nv">offset</span> <span class="o">=</span> 0x4040<span class="o">)</span>
  <span class="nb">type</span> <span class="o">=</span> T_DIR    <span class="o">(</span>File <span class="nb">type</span><span class="o">)</span>
  <span class="nv">nlink</span> <span class="o">=</span> <span class="m">00000001</span> <span class="o">(</span>Number of links to inode <span class="k">in</span> file system<span class="o">)</span>
  <span class="nv">size</span> <span class="o">=</span> <span class="m">00000200</span> <span class="o">(</span>Size of file <span class="o">(</span>bytes<span class="o">))</span>
<span class="o">[</span><span class="m">00</span><span class="o">]</span> <span class="o">=</span> 0000003b    -&gt;  ................ ................ ..README
  <span class="m">01</span> -&gt; .
  <span class="m">01</span> -&gt; ..
  <span class="m">02</span> -&gt; README
  <span class="m">03</span> -&gt; cat
  <span class="m">04</span> -&gt; <span class="nb">echo</span>
  <span class="m">05</span> -&gt; forktest
  <span class="m">06</span> -&gt; grep
  <span class="m">07</span> -&gt; init
  <span class="m">08</span> -&gt; <span class="nb">kill</span>
  <span class="m">09</span> -&gt; ln
  <span class="m">10</span> -&gt; ls
  <span class="m">11</span> -&gt; mkdir
  <span class="m">12</span> -&gt; rm
  <span class="m">13</span> -&gt; sh
  <span class="m">14</span> -&gt; stressfs
  <span class="m">15</span> -&gt; usertests
  <span class="m">16</span> -&gt; wc
  <span class="m">17</span> -&gt; zombie
  <span class="m">18</span> -&gt; console
</pre></div>
</div>
<p>How could you add a new dirent { inum = 19, name = “hello” } at the end
of the first inode (ino = 1)? Try to boot (<cite>make qemu</cite>) and
run <cite>ls</cite> on xv6 with the modified <cite>fs.img</cite>.
HINT. Where is the actual block that contains the dirents?</p>
</section>
<section id="mkfs">
<h2>mkfs<a class="headerlink" href="#mkfs" title="Permalink to this heading">¶</a></h2>
<p>In xv6, <cite>mkfs.c’ is a standalone program for creating the file system `fs.img</cite>.
Please read carefully through the code to see how it works. Answer the following
questions.</p>
<ol class="arabic simple">
<li><p>How large can each file be in xv6 and why is this limitation?</p></li>
<li><p>How can you increase the maximum size of a file? Discuss the steps.</p></li>
<li><p>Next, look at the <cite>wsect()</cite> and <cite>rsect()</cite> functions in xv6. For every block that
should be written or read it does a lseek() to the actual block location.
Can you modify the <cite>wsect()</cite> and <cite>rsect()</cite> to support simple memory copy operation to
read or write a block?</p></li>
</ol>
<p>HINT: First, when you open the file, <cite>mmap()</cite> the file to a global pointer.
Then use the global pointer inside <cite>wsect()</cite> and  <cite>rsect()</cite> as shown in code
snippet below. Also, when you mmap the file, make sure to seek and write a dummy
byte to the last location.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"></span>
<span class="nf">wsect</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">sec</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BSIZE</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">//copy to the global mmap pointer here</span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"></span>
<span class="nf">rsect</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">sec</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BSIZE</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">//copy from the global mmap pointer here</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If you did it correct, you can use the image file to boot xv6 and list the
files you included when creating the image.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcc -g mkfs.c -o mkfs
$ ./mkfs fs.img _init _ln _ls _mkdir  _sh  _stressfs _usertests  _zombie ...
$ make qemu
$ ls
</pre></div>
</div>
</section>
<section id="log">
<h2>log<a class="headerlink" href="#log" title="Permalink to this heading">¶</a></h2>
<p>We are going to dump the log entries in <cite>fs.img</cite> by using <cite>dumplog</cite>,
which simply dump stashing blocks recorded in the log region. Please
download <a class="reference external" href="r/dumplog.c">dumplog.c</a>  and compile it like below.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> xv6
<span class="p">;</span> please run at least once so that xv6 creates a console file
$ make qemu
<span class="p">;</span> <span class="nb">kill</span> xv6

$ gcc -Werror -Wall -std<span class="o">=</span>gnu11 -o dumplog dumplog.c
$ ./dumplog fs.img
&gt; sizeof<span class="o">(</span>superblock<span class="o">)</span> <span class="o">=</span> <span class="m">8</span>
      <span class="nv">size</span> <span class="o">=</span> 000003e8 <span class="o">(</span>Size of file system image <span class="o">(</span>blocks<span class="o">))</span>
   <span class="nv">nblocks</span> <span class="o">=</span> 000003ad <span class="o">(</span>Number of data blocks<span class="o">)</span>
   <span class="nv">ninodes</span> <span class="o">=</span> 000000c8 <span class="o">(</span>Number of inodes<span class="o">)</span>
      <span class="nv">nlog</span> <span class="o">=</span> 0000001e <span class="o">(</span>Number of log blocks<span class="o">)</span>
  <span class="nv">logstart</span> <span class="o">=</span> <span class="m">00000002</span> <span class="o">(</span>Block number of first log block<span class="o">)</span>
<span class="nv">inodestart</span> <span class="o">=</span> <span class="m">00000020</span> <span class="o">(</span>Block number of first inode block<span class="o">)</span>
 <span class="nv">bmapstart</span> <span class="o">=</span> 0000003a <span class="o">(</span>Block number of first free map block<span class="o">)</span>
&gt; loghead <span class="o">(</span><span class="nv">n</span><span class="o">=</span><span class="m">0</span><span class="o">)</span>
&gt;  block<span class="o">[</span><span class="m">00</span><span class="o">]</span> <span class="o">=</span> <span class="m">034</span>:  .........5...... ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">01</span><span class="o">]</span> <span class="o">=</span> <span class="m">059</span>:  ................ ................ ..README........ ..cat...........
&gt;  block<span class="o">[</span><span class="m">02</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">03</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">04</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">05</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">06</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">07</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">08</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">09</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">10</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">11</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">12</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">13</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">14</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">15</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">16</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">17</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">18</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">19</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">20</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">21</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">22</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">23</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">24</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">25</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">26</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">27</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">28</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
&gt;  block<span class="o">[</span><span class="m">29</span><span class="o">]</span> <span class="o">=</span> <span class="m">000</span>:  ................ ................ ................ ................
</pre></div>
</div>
<p>To emulate unsuccessful commits, we are going to inject two errors
to the <cite>commit()</cite> function (see, two panics in below).</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// xv6/log.c</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">commit</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="n">lh</span><span class="p">.</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">write_log</span><span class="p">();</span><span class="w">     </span><span class="c1">// Write modified blocks from cache to log</span>
<span class="w">    </span><span class="c1">// Q1: panic(&quot;after writing to log!&quot;);</span>
<span class="w">    </span><span class="n">write_head</span><span class="p">();</span><span class="w">    </span><span class="c1">// Write header to disk -- the real commit</span>
<span class="w">    </span><span class="c1">// Q2: panic(&quot;after writing the loghead!&quot;);</span>
<span class="w">    </span><span class="n">install_trans</span><span class="p">();</span><span class="w"> </span><span class="c1">// Now install writes to home locations</span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="n">lh</span><span class="p">.</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">write_head</span><span class="p">();</span><span class="w">    </span><span class="c1">// Erase the transaction from the log</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Your task is to uncomment each panic, trigger the injected bug, and
interpret its result (e.g., <cite>fs.img</cite>) with <cite>dumplog</cite>.</p>
<p>Specifically, after uncommenting each panic, please run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ make qemu
<span class="p">;</span> on xv6, trigger commit<span class="o">()</span>
$ cat README &gt; x
<span class="p">;</span> <span class="nb">kill</span> qemu

$ ./dumplog fs.img
...
</pre></div>
</div>
<p>Please interpret two outputs from dumplog.</p>
</section>
</section>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="refs.html" class="btn btn-neutral float-right" title="Reference Materials">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cal.html" class="btn btn-neutral" title="Schedule"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      Last updated on Jul 12, 2022.
    </p>
  </div>

</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

<script src="_static/email.js"></script>
<script src="_static/custom.js"></script>

</body>
</html>